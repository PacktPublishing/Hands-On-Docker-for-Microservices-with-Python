services:
  - docker

env:
  global:
    - DOCKER_COMPOSE_VERSION=1.23.2
      secure: "t+WW1xbBVPOOQuDKfEauw0l7K1a6U4IhW0PsY0UeVaBluAYXeodScieKP8o/QdYRJht9r5w0KnQIOZ6xFiBj2EvQ1enL37WTIxwPs/0HRahOlImYdlws2i2wpr691BBGLeRFQ3UGbWMc4mIycj11jnf6i/bpKIhBGIz2D+IQE17bsfVKGS0j2To2lDYnF/HJlGzF2ZHQjP6+vMt9PF5a2+E3m8pBAn4QbzyYwyyu38jnK158V+zYcJU+3ACLreDLBdC130HQtei4Z7X0yXwGzzcYC3iqrJDq7vUrgeELHlfOwLQzUCf4g4ejD2erE67COF9pi0SsSOrbzGRxFn03fCUcSbKkbgL5XtqHUMk6qDLJ8fNN5ving0NFc3MWE5GRdP9iqenxHpxkJv6qrXfgLbBoweiz9OhL0lJBSIgBnAIfvOjghlRlebTy3WRXfFQd0hq3sx/nlsmgt6TZaX1/QmBeig1L3/u56nd7vKUHtHojotbDQj36RfNIr5JX6OHJBxc1soBhrZxgp36Q87FGZVj2jhI+cPLQcDGpAa+Ehv7FChHxZH6yb/IxOUQEOmWExVy37zs3w6rUF/gr9Ss1JdvD7lqP1UkRq06Udxxn2R0Y+3Dl61XRNaVdzQngc/wRvdNyASl8g/M3aRzN7UtFrzd10BkCQ3LIWouSY0BoAgA="
      secure: "RyG8gBwSdLap341VUSz0HTFQ4NGUX0vpSj4mTC3HdircLbEfl+xNX2K0w+lQbfG4XG9JTgL695pLqNIymp1eGB0F/wvtRfY7GRsMiXP4pAkKlyUyF16iwn0Ue44musinRb6reGg7rfGs2y4PmB/imawh+PWrbnwLl6nnud+XLgpp0hZGnkhct7nZz+YCJhmpZovTKekxvvynE4VttEJHlW2+dCuvT1o9R/M1Aey/gbxkpOsxrUbv7Za/vT35xbl8C63qvnywvhwnNnfeIG6+jhN6FyoiahW5y4hqG8xDxZtUI9/NalFeeG3ubA3E2S40879IRE0ILku5UZtUps9zvGokFymE7wqdph5/ZcMhp6MLygh/UWEXR+i3MpjctKQXMt0RzqLNKtZzEfCXHvAAJtZtj0MA22JS21o7b+Q2haedT97CIR7vv9TiDFSRaZPBpcVps3D8X37gWzsI20CQGJ0WEoMMzzW4xtPyuHZsVMu4zAXOurJTiKGVH9mmEHup9RHzU7K4OjDzMulYtoQItXIeOXq+1ELMPjBEsoYHLHyQdA6Jar6NfwauuD/5HnQ2xUVCYSJT2b6FHjB7dY/yFNPnO7HUiAoxIOGurDeJ+5vrApKg1yGpw6PMhfh9RbL3z2v7y9Uol6UmfGZJfcZ56OgLklkHofIjTfgfn11d0Kk="

before_install:
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - docker --version
  - docker-compose version
  - echo "Login into Docker Hub"
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - export GIT_SHA=`git rev-parse --short HEAD`
  - echo "Building commit $GIT_SHA"

jobs:
  include:
    - stage: tests
      name: "Unit Tests"
      script:
      - cd ch4
      - docker-compose build db
      - docker-compose build test-postgresql
      - docker-compose run test-postgresql
    - stage: tests
      name: "Static Analysis"
      script:
      - cd ch4
      - docker-compose build static-analysis
      - docker-compose run static-analysis
    - stage: push
      script:
      - cd ch4
      - docker-compose build server
      - docker tag thoughts_server:latest jaimebuelta/thoughts-backend:$GIT_SHA
      - docker push jaimebuelta/thoughts-backend:$GIT_SHA
      - docker tag thoughts_server:latest jaimebuelta/thoughts-backend:$TRAVIS_BRANCH
      deploy:
      - provider: script
        script: docker push jaimebuelta/thoughts-backend:$TRAVIS_BRANCH
        on:
          branch: master        
      - provider: script
        script: docker push jaimebuelta/thoughts-backend:$TRAVIS_TAG
        on:
          tags: True
